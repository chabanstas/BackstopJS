name: WDIO-allure
on:
push:
    branches: [ main, master ]
pull_request:
    branches: [ main, master ]
jobs:
test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2                     # clone repo to the machine
    - uses: actions/setup-node@v2                   # install nodeJS
    with:
        node-version: '14.x'
    - name: Install dependencies                    # install dependencies from package-lock.json
    run: npm install -g backstopjs
     - name: Create reference                                # start tests
    run: backstop reference
    - name: Run test                                # start tests
    run: backstop test
    - uses: actions/checkout@v2                     # clone branch with report to current branch
    if: always()
    with:
        repository: chabanstas/BackstopJS
        ref: backstopjs-report
        path: ./bitmaps_test
    
    - uses: actions/upload-artifact@v2              # upload allure report as an artifact of this run
    if: always()
    with:
        name: backstop-report
        path: backstop_data/bitmaps_test/
        retention-days: 30
    - name: Push Build To Other Branch              # push this report to the other branch
        uses: s0/git-publish-subdir-action@develop
        env:
        REPO: self
        BRANCH: report # The branch name where you want to push the assets
        FOLDER: ./bitmaps_test # The directory where your assets are generated
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub will automatically add this - you don't need to bother getting a token
        MESSAGE: "Build: ({sha}) {msg}" # The commit message
